<!DOCTYPE html>
<html>
<style>
    * {
        box-sizing: border-box;
    }

    form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 4px;
    }

    fieldset {
        grid-column: 1 / 3;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 4px;
    }

    h2 {
        grid-column: 1 / 3;
    }

    button {
        grid-column: 1 / 3;
        max-width: 200px;
    }

    label {
        grid-column: 1 / 2;
        max-width: 200px;
    }

    input {
        grid-column: 2 / 3;
        max-width: 200px;
    }

    input[type=button] {
        grid-column: 1 / 3;
    }

    /* Style the tab */
    .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
    }

    /* Style the buttons that are used to open the tab content */
    .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
    }

    /* Change background color of buttons on hover */
    .tab button:hover {
        background-color: #ddd;
    }

    /* Create an active/current tablink class */
    .tab button.active {
        background-color: #ccc;
    }

    /* Style the tab content */
    .tabcontent {
        display: none;
        padding: 6px 12px;
        border: 1px solid #ccc;
        border-top: none;
        animation: fadeEffect 1s;
        /* Fading effect takes 1 second */
        background-color: #ddddee;
    }

    /* Go from zero to full opacity */
    @keyframes fadeEffect {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }
</style>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>NMEA Bridge</title>
</head>

<body onload="javascript:load()">
    <div class="tab">
        <button id='tabGeneral' class="tablinks" onclick="showTab(event, 'General')">General</button>
        <button class="tablinks" onclick="showTab(event, 'NMEAStream')">NMEA Stream</button>
        <button class="tablinks" onclick="showTab(event, 'Bluetooth')">Bluetooth</button>
        <button class="tablinks" onclick="showTab(event, 'WIFI')">WIFI</button>
        <button class="tablinks" onclick="showTab(event, 'Console')">Console</button>
        <button class="tablinks" onclick="showTab(event, 'Reset')">Reset</button>
    </div>

    <!-- Tab content -->
    <div id="General" class="tabcontent">
        <h3>General</h3>
        <div class="card">
            NMEA2000 bus voltage: <span id="ADCValue">0</span>V<br>
        </div>
        <form name="demoSettings">
            <!-- Add a dummy element so the form is always populated to work around bug in Webserver library, which cannot handle multiplart forms without any data. -->
            <input type="hidden" id="demoSettingsForm" name="demoSettingsForm" value="dummy" />
            <label for="demoEnabled">Demo data Enabled</label>
            <input type="checkbox" id="demoEnabled" name="demoEnabled"/><br>
            <input type="button" value="Save Demo Settings" onclick="submitForm(this.form.name)"/>
        </form>
    </div>
    <div id="NMEAStream" class="tabcontent">
        <form name="nmeaSettings">
            <!-- Add a dummy element so the form is always populated to work around bug in Webserver library, which cannot handle multiplart forms without any data. -->
            <input type="hidden" id="nmeaSettingsForm" name="nmeaSettingsForm" value="dummy" />
            <h2>NMEA 0183 sources in use:</h2>
            <label for="nmeaSrcBlGps">Bluetooth GPS</label>
            <input type="checkbox" id="nmeaSrcBlGps" name="nmeaSrcBlGps"/><br>
            <label for="nmeaSrcN2k">N2K bus</label>
            <input type="checkbox" id="nmeaSrcN2k" name="nmeaSrcN2k"/><br>
            <label for="nmeaSrcSerial1">Serial 1 - 38400 bps (AIS)</label>
            <input type="checkbox" id="nmeaSrcSerial1" name="nmeaSrcSerial1"/><br>
            <label for="nmeaSrcSerial2">Serial 2 - 4800 bps</label>
            <input type="checkbox" id="nmeaSrcSerial2" name="nmeaSrcSerial2"/><br>
            <h2>Send NMEA 0183 messages to:</h2>
            <label for="nmeaToSerial">Console</label>
            <input type="checkbox" id="nmeaToSerial" name="nmeaToSerial"/><br>
            <label for="nmeaToSocket">Browser</label>
            <input type="checkbox" id="nmeaToSocket" name="nmeaToSocket"/><br>
            <label for="nmeaToBl">Bluetooth clients</label>
            <input type="checkbox" id="nmeaToBl" name="nmeaToBl"/><br>
            <label for="nmeaToUDP">WIFI clients (via UDP)</label>
            <input type="checkbox" id="nmeaToUDP" name="nmeaToUDP"/><br>
            <h2>NMEA 2000 Configuration:</h2>
            <label for="nmea2000ToSerial">Log NMEA 2000 to Console</label>
            <input type="checkbox" id="nmea2000ToSerial" name="nmea2000ToSerial"/><br>
            <label for="nmea2000Mode">Mode</label>
            <select id="nmea2000Mode" name="nmea2000Mode">
                <option value="0">Receive</option>
                <option value="1">Send</option>
                <option value="2">Receive and Send</option>
                <option value="3">Send (stealth)</option>
                <option value="4">Receive and Send (stealth)</option>
              </select>             
            <input type="button" value="Save NMEA Settings" onclick="submitForm(this.form.name)"/>
        </form>
        <textarea id="nmeaStreamPrint" rows="10" cols="81" disabled="disabled"></textarea>
    </div>
    <div id="Bluetooth" class="tabcontent">
        <h3>Bluetooth</h3>
        <p>Configure bluetooth.</p>
        <form name="bluetoothSettings">
            <!-- Add a dummy element so the form is always populated to work around bug in Webserver library, which cannot handle multiplart forms without any data. -->
            <input type="hidden" id="bluetoothSettingsForm" name="bluetoothSettingsForm" value="dummy" />
            <label for="blEnabled">Bluetooth Enabled</label>
            <input type="checkbox" id="blEnabled" name="blEnabled"/><br>
            <input type="button" value="Save Bluetooth Settings" onclick="submitForm(this.form.name)"/>
        </form>
    </div>
    <div id="WIFI" class="tabcontent">
        <h3>WIFI</h3>
        <p>Configure wifi. Requires a reset.</p>
        <form name="wifiSettings">
            <h2>General WIFI settings</h2>
            <label for="wifiUdpPort">WIFI - UDP Broadcast Port</label>
            <input type="number" id="wifiUdpPort" name="wifiUdpPort" min="1025" max="66535"><br>

            <label for="wifiStaEnabled">Use WIFI Station</label>
            <input type="checkbox" id="wifiStaEnabled" onchange="toggleWifiStationOrAPVisibility(this.checked)"
                name="wifiStaEnabled"/><br>
            <h2>WIFI Station</h2>
            <fieldset name="wifiStation" disabled>
                <label for="wifiStaHostname">Hostname</label>
                <input type="text" id="wifiStaHostname" name="wifiStaHostname"/><br>

                <label for="wifiStaSsid">SSID</label>
                <input type="text" id="wifiStaSsid" name="wifiStaSsid"/><br>

                <label for="wifiStaPassw">Password</label>
                <input type="password" id="wifiStaPassw" name="wifiStaPassw"/><br>
            </fieldset>
            <h2>WIFI Access Point</h2>
            <fieldset name="wifiAP">
                <label for="wifiApSsid">SSID</label>
                <input type="text" id="wifiApSsid" name="wifiApSsid"/><br>

                <label for="wifiApPassword">Password</label>
                <input type="password" id="wifiApPassword" name="wifiApPassword"/><br>
            </fieldset>
            <input type="button" value="Save WIFI settings" onclick="submitForm(this.form.name)"/>
        </form>
    </div>
    <div id="Console" class="tabcontent">
        <p id="consoleLog"></p>
    </div>
    <div id="Reset" class="tabcontent">
        <p>Danger zone!</p>
        <button name="reboot" type="button" onclick="executeAction(this.name)">Reboot ESP</button> <br>
        <button name="reset" type="button" onclick="executeAction(this.name)">Reset</button> <br>
        <button name="factoryReset" type="button" onclick="executeAction(this.name)">Factory Reset</button>
    </div>
    <script>
        //Show General tab by default.
        document.getElementById("tabGeneral").click();
        toggleWifiStationOrAPVisibility(document.getElementById("wifiStaEnabled").checked);

        function load() {

            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "load", true);
            xhttp.onload  = function() {
                var json = JSON.parse(xhttp.responseText);
                setBoolean(json,"demoEnabled");
                setBoolean(json,"nmeaToSerial");
                setBoolean(json,"nmeaToSocket");
                setBoolean(json,"nmeaToBl");
                setBoolean(json,"nmeaToUDP");
                setBoolean(json,"nmeaSrcBlGps");
                setBoolean(json,"nmeaSrcN2k");
                setBoolean(json,"nmeaSrcSerial1");
                setBoolean(json,"nmeaSrcSerial2");
                setBoolean(json,"nmea2000ToSerial");
                setListValue(json,"nmea2000Mode0","nmea2000Mode",0);
                setListValue(json,"nmea2000Mode0","nmea2000Mode",1);
                setListValue(json,"nmea2000Mode0","nmea2000Mode",2);
                setListValue(json,"nmea2000Mode0","nmea2000Mode",3);
                setListValue(json,"nmea2000Mode0","nmea2000Mode",4);
                setBoolean(json,"blEnabled");
                setValue(json,"wifiUdpPort");
                setBoolean(json,"wifiStaEnabled");
                setValue(json,"wifiStaHostname");
                setValue(json,"wifiStaSsid");
                setValue(json,"wifiStaPassw");
                setValue(json,"wifiApSsid");
                setValue(json,"wifiApPassword");
            };
            xhttp.send();
        }

        function setBoolean(json, name) {
            document.getElementsByName(name)[0].checked = json[name];
        }
        function setValue(json, name) {
            document.getElementsByName(name)[0].value = json[name];
        }
        function setListValue(json, jsonField, list, index) {
            document.getElementById(list).getElementsByTagName("option")[index].selected = json[jsonField] ? 'selected' : '';
        }

        function showTab(evt, tabName) {
            // Declare all variables
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function toggleWifiStationOrAPVisibility(checked) {
            document.getElementsByName("wifiStation")[0].disabled = !checked;
            document.getElementsByName("wifiAP")[0].disabled = checked;
        }
        function executeAction(action) {
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", action, true);
            xhttp.send();
        }

        function submitForm(formName) {
            var formElement = document.forms.namedItem(formName);
            var formData = new FormData(formElement);
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST", formName, true);
            xhttp.send(formData);
            return false;
        }
    </script>
    <script type="text/javascript">
        var webSocket = null;
        wsStart();
        function wsStop() {
            webSocket.close();
        }
        function wsStart() {
            var webSocketURL = "ws://" + location.hostname + ":8080";
            console.log("openWSConnection::Connecting to: " + webSocketURL);
            try {
                webSocket = new WebSocket(webSocketURL);
                webSocket.onopen = function (openEvent) {
                    console.log("WebSocket OPEN: " + JSON.stringify(openEvent, null, 4));
                };
                webSocket.onclose = function (closeEvent) {
                    console.log("WebSocket CLOSE: " + JSON.stringify(closeEvent, null, 4));
                };
                webSocket.onerror = function (errorEvent) {
                    console.log("WebSocket ERROR: " + JSON.stringify(errorEvent, null, 4));
                };
                webSocket.onmessage = function (messageEvent) {
                    var message = messageEvent.data;
                    if (message.startsWith("N:")) {
                        var textarea = document.getElementById("nmeaStreamPrint");
                        textarea.value += message.replace("N:", "") + "\r\n";
                        textarea.scrollTop = textarea.scrollHeight;
                    } else if (message.startsWith("V:")) {
                        document.getElementById("ADCValue").innerHTML = message.replace("V:", "");
                    } else if (message.startsWith("L:")) {
                        var text = message.replace("L:", "");
                        var newLine = document.createTextNode(text);
                        var paragraph = document.getElementById("consoleLog");
                        paragraph.appendChild(newLine);
                        paragraph.appendChild(document.createElement("br"));
                    }
                };
            } catch (exception) {
                console.error(exception);
            }
        }
    </script>
</body>

</html>